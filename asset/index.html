<html>
  <head>
    <title>SpeedKetchup</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" type="text/css" href="uplot.css">
    <script type="text/javascript" src="uplot.js"></script>
    <script type="text/javascript" src="data.js"></script>
    <style>
      html, body {
	  max-width: 100%;
	  overflow-x: hidden;
      }
    </style>
  </head>
  <body style="margin: 0; padding: 0; font-family: verdana; font-size: 11px;">
    <div id="dashboard" style="background-image: linear-gradient(#e3d99a, #fff);" width="100%">
      <svg viewBox="-100 0 400 100" xmlns="http://www.w3.org/2000/svg" height="150px" style="margin-left: 50%; transform: translateX(-50%);">
	<style>
	  .st {
	      font-family: verdana;
	      font-size: 6px;
	      cursor: default;
	      user-select: none;
	  }
	  .bt {
	      font-family: verdana;
	      font-size: 15px;
	      cursor: default;
	      user-select: none;
	  }
	  .button {
	      filter: drop-shadow(0px 0px 2px #0000);
	      transition: filter .2s ease;
	  }
	  .button:hover {
	      filter: drop-shadow(0px 0px 2px #0008);
	  }
	  .button:active {
	      filter: drop-shadow(0px 0px 2px #0000);
	  }
	</style>
	<defs>
	  <filter id="f3" x="0" y="0" width="200%" height="200%">
	    <feOffset result="offOut" in="SourceAlpha" dx="10" dy="10" />
	    <feGaussianBlur result="blurOut" in="offOut" stdDeviation="10" />
	    <feBlend in="SourceGraphic" in2="blurOut" mode="normal" />
	  </filter>
	  <g id="spd">
	    <path d="M 50 50
		     m -28 28
		     a 40 40 1 1 1 56 0
		     l -6 -6
		     a 32 32 1 1 0 -44 0
		     z"
		  fill="#ddd"/>
	    <circle cx="50" cy="50" r="4" fill="#ddd"/>
	    <text text-anchor="middle" x="30" y="72" class="st">0</text>
	    <text text-anchor="middle" x="24" y="42" class="st">1</text>
	    <text text-anchor="middle" x="50" y="25" class="st">10</text>
	    <text text-anchor="middle" x="72" y="42" class="st">100</text>
	    <text text-anchor="middle" x="65" y="72" class="st">1000</text>
	  </g>
	  <path id="needle" d="M 50 50
			       m -2 0
			       a 2 2 1 1 0 4 0
			       l -2 -38
			       z"
		/>
	</defs>

	<path d="M -50 101
		 v -1
		 A 50 50 0 0 0 0 50
		 V 50
		 A 50 50 0 0 1 50 0
		 H 150
		 A 50 50 0 0 1 200 50
		 A 50 50 0 0 0 250 100
		 v 1
		 z"
	      fill="#fff" filter="url(#f3)"/>

	<use x="0" y="0" href="#spd"/>
	<use x="100" y="0" href="#spd"/>
	<path id="download_band" d="M 50 50
		     m -28 28
		     a 40 40 1 1 1 56 0
		     l -6 -6
		     a 32 32 1 1 0 -44 0
		     z"
		  fill="#fdd"/>
	<path id="upload_band" d="M 150 50
		     m -28 28
		     a 40 40 1 1 1 56 0
		     l -6 -6
		     a 32 32 1 1 0 -44 0
		     z"
		  fill="#ddf"/>
	<path id="download_progress" d="M 50 50
		 m -28 28
		 a 40 40 1 1 1 56 0
		 l 2 2
		 a 43 43 1 1 0 -60 0
		 z"
	      fill="#000"/>
	<path id="upload_progress" d="M 150 50
		 m -28 28
		 a 40 40 1 1 1 56 0
		 l 2 2
		 a 43 43 1 1 0 -60 0
		 z"
	      fill="#000"/>

	<use id="download_needle" x="0" y="0" href="#needle" fill="#d00" transform="rotate(-67.5, 50, 50)"/>
	<use id="upload_needle" x="100" y="0" href="#needle" fill="#00d" transform="rotate(67.5, 150, 50)"/>

	<text text-anchor="middle" x="50" y="75" class="bt" fill="#d00"><title>Download</title>â–¼</text>
	<text text-anchor="middle" x="50" y="90" class="bt"><title>Download Speed Mbps</title>78.5</text>
	<text text-anchor="middle" x="75" y="90" class="st">Mbps</text>
	<text text-anchor="middle" x="50" y="98" class="st"><title>Latency While Downloading</title>128ms</text>

	<text text-anchor="middle" x="150" y="75" class="bt" fill="#00d"><title>Upload</title>â–²</text>
	<text text-anchor="middle" x="150" y="90" class="bt"><title>Upload Speed Mbps</title>39.1</text>
	<text text-anchor="middle" x="175" y="90" class="st">Mbps</text>
	<text text-anchor="middle" x="150" y="98" class="st"><title>Latency While Uploading</title>80.1ms</text>

	<g id="play_button" class="button" style="cursor: pointer;" >
	  <title>Start Test Now</title>
	  <circle cx="100" cy="18" r="12" fill="#0c0" />
	  <path d="M 97 13 l 10 5 l -10 5 z" fill="#fff"/>
	</g>
	<g id="stop_button" class="button" style="cursor: pointer; visibility: hidden;" >
	  <title>Stop Test</title>
	  <circle cx="100" cy="18" r="12" fill="#0c0" />
	  <path d="M 96 14 h8 v8 h-8 z" fill="#fff"/>
	</g>
	<g id="disconnected_button" style="visibility: hidden;">
	  <title>Connection Lost</title>
	  <circle cx="100" cy="18" r="12" fill="#ddd" />
	  <circle cx="100" cy="18" r="3" fill="#fff" />
	</g>
	<text text-anchor="middle" x="100" y="75" class="st"><title>Time Till Next Test</title>00:00</text>
	<text text-anchor="middle" x="100" y="98" class="st"><title>Latency While Idle</title>32.4ms</text>
      </svg>
    </div>
    <div id="chart1"></div>
    <div id="chart2"></div>
    <div id="status">X</div>
    <div id="idle_time">X</div>
    <script type="text/javascript">
function getSize() {
    let h = Math.max(window.innerHeight / 2 - 150, 200);
    return {
	width: window.innerWidth,
	height: h,
    }
}

function formatNumber(num, width) {
    var ret = "" + num;
    while (ret.length < width) {
	ret = "0" + ret;
    }
    return ret;
}

function debug(str) {
    if (!console) {
	return;
    }
    if (typeof str == "string") {
	var d = new Date();
	console.debug(
	    d.getFullYear() + "." +
		formatNumber(d.getMonth() + 1, 2) + "." +
		formatNumber(d.getDate(), 2) + " " +
		formatNumber(d.getHours(), 2) + ":" +
		formatNumber(d.getMinutes(), 2) + ":" +
		formatNumber(d.getSeconds(), 2) + "." +
		formatNumber(d.getMilliseconds(), 3) + ": " + str);
    }
    else {
	console.debug(str);
    }
}

function request(obj, cb) {
//    debug("request");
    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
	if (req.readyState == 4) {
	    if (req.status == 200) {
		cb(req.responseText);
	    }
	    else {
		cb(null);
	    }
	    req = null;
        }
    };
    req.timeout = 60 * 1000;
    req.open("POST", "/status", true);
//    if (binary) {
//	req.setRequestHeader("Content-Type", "msg");
//	req.setRequestHeader("Accept-Language", "");
//	req.responseType = "arraybuffer";
//    }
    req.send(obj);
}

var stateStr = "";
var stateObj = {};
function onRequest(r) {
    debug("on request " + r);
    var el = document.getElementById('status');
    if (r == null) {
	stateStr = "connection lost";
	stateObj = {};
	el.innerText = "Status: ðŸ”´ connection lost";
	setTimeout(function () { request(null, onRequest); }, 1000);
	return;
    }

    stateStr = r;
    obj = JSON.parse(r);
    debug("old:" + stateObj.state + " new:" + obj.state);
    if (stateObj.state && stateObj.state != "idle" && obj.state == "idle") {
	// reload when going idle
	debug("reload on idle");
	window.location.reload();
	return;
    }
    stateOld = stateObj;
    stateObj = obj;
    if (stateObj.idle_time) {
	updateIdleTime();
    }
    else {
	cleanupIdleTime();
    }
    el.innerText = "Status: ðŸŸ¢ " + r;
    setTimeout(function () { request(stateStr, onRequest); }, 100);
};

var idleTimer = null;
function updateIdleTime() {
//    debug("updateIdleTime");
    if (idleTimer) {
	clearTimeout(idleTimer);
    }
    idleTimer = null;
    var el = document.getElementById('idle_time');
    var it = stateObj.idle_time;
    if (!it || it < 0) {
	cleanupIdleTime();
	return;
    }
    el.innerText = "next test after " + formatNumber(Math.floor(it / 60), 2) + ":" + formatNumber(it % 60, 2);
    idleTimer = setTimeout(function() { stateObj.idle_time -= 1; updateIdleTime(); }, 1000);
}

function cleanupIdleTime() {
    var el = document.getElementById('idle_time');
    el.innerText = "X";
    if (idleTimer) {
	clearTimeout(idleTimer);
    }
}

function initSpeedKetchup() {
    let mooSync = uPlot.sync("moo");
    const matchSyncKeys = (own, ext) => own == ext;

    const cursorOpts = {
	lock: true,
	sync: {
	    key: mooSync.key,
//	    setSeries: true,
	    match: [matchSyncKeys, matchSyncKeys],
	},
	y: false,
    };

    let axis = [
	{
            grid: {
                show: true,
                stroke: "rgba(0,0,0,0.2)",
                width: 1,
            },
	},
	{
            grid: {
                show: true,
                stroke: "rgba(0,0,0,0.2)",
                width: 1,
            },
	},
    ];
    let series = {
	points: {
	    show: false,
	    size: 5,
	    fill: "black",
	}
    };

    let d = [data[0], data[4], data[5]];
    let opts = {
	title: "Speed (Bandwidth)",
	...getSize(),
	cursor: cursorOpts,
	drawOrder: ["series", "axes"],
	series: [
	    {},
	    {
		label: "Download",
		value: (u, v) => (v == null ? d[1][d[1].length - 1] : v).toFixed(1) + "Mbps",
		fill: "rgba(255, 0, 0, 0.7)",
//		stroke: "red",
		...series,
	    },
	    {
		label: "Upload",
		value: (u, v) => (v == null ? d[2][d[2].length - 1] : v).toFixed(1) + "Mbps",
		fill: "rgba(0, 0, 255, 0.7)",
//		stroke: "blue",
		...series,
	    }
	],
	axes: axis,
    };
    let uplot = new uPlot(opts, d, document.getElementById("chart1"));

    let d2 = [data[0], data[2], data[3], data[1]];
    let opts2 = {
	title: "Ping (Latency)",
	...getSize(),
	cursor: cursorOpts,
	drawOrder: ["series", "axes"],
	series: [
	    {},
	    {
		label: "Latency While Downloading",
		value: (u, v) => (v == null ? d2[1][d2[1].length - 1] : v).toFixed(1) + "ms",
		fill: "rgba(255, 0, 0, 0.3)",
		...series,
	    },
	    {
		label: "Latency While Uploading",
		value: (u, v) => (v == null ? d2[2][d2[2].length - 1] : v).toFixed(1) + "ms",
		fill: "rgba(0, 0, 255, 0.3)",
		...series,
	    },
	    {
		label: "Latency When Idle",
		value: (u, v) => (v == null ? d2[3][d2[3].length - 1] : v).toFixed(1) + "ms",
		fill: "rgba(50, 150, 50, 1)",
		...series,
	    },
	],
	axes: axis,
    };
    let uplot2 = new uPlot(opts2, d2, document.getElementById("chart2"));

    window.addEventListener("resize", e => {
	uplot.setSize(getSize());
	uplot2.setSize(getSize());
    });

    request(null, onRequest);
}
window.onload = initSpeedKetchup;
    </script>
  </body>
</html>
