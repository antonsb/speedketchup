<html>
  <head>
    <title>SpeedKetchup</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="/favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" type="text/css" href="uplot.css">
    <script type="text/javascript" src="uplot.js"></script>
    <script type="text/javascript" src="data.js"></script>
    <style>
      html, body {
	  max-width: 100%;
	  overflow-x: hidden;
      }
    </style>
  </head>
  <body style="margin: 0; padding: 0; font-family: verdana; font-size: 11px;">
    <div id="dashboard" style="background-image: linear-gradient(#e3d99a, #fff);" width="100%">
      <img src="dashboard.svg" height="150px" style="    margin-left: 50%;
    transform: translateX(-50%);
">
    </div>
    <div id="chart1"></div>
    <div id="chart2"></div>
    <div id="status">X</div>
    <div id="idle_time">X</div>
    <script type="text/javascript">
function getSize() {
    let h = Math.max(window.innerHeight / 2 - 150, 200);
    return {
	width: window.innerWidth,
	height: h,
    }
}

function formatNumber(num, width) {
    var ret = "" + num;
    while (ret.length < width) {
	ret = "0" + ret;
    }
    return ret;
}

function debug(str) {
    if (!console) {
	return;
    }
    if (typeof str == "string") {
	var d = new Date();
	console.debug(
	    d.getFullYear() + "." +
		formatNumber(d.getMonth() + 1, 2) + "." +
		formatNumber(d.getDate(), 2) + " " +
		formatNumber(d.getHours(), 2) + ":" +
		formatNumber(d.getMinutes(), 2) + ":" +
		formatNumber(d.getSeconds(), 2) + "." +
		formatNumber(d.getMilliseconds(), 3) + ": " + str);
    }
    else {
	console.debug(str);
    }
}

function request(obj, cb) {
//    debug("request");
    var req = new XMLHttpRequest();
    req.onreadystatechange = function() {
	if (req.readyState == 4) {
	    if (req.status == 200) {
		cb(req.responseText);
	    }
	    else {
		cb(null);
	    }
	    req = null;
        }
    };
    req.timeout = 60 * 1000;
    req.open("POST", "/status", true);
//    if (binary) {
//	req.setRequestHeader("Content-Type", "msg");
//	req.setRequestHeader("Accept-Language", "");
//	req.responseType = "arraybuffer";
//    }
    req.send(obj);
}

var stateStr = "";
var stateObj = {};
function onRequest(r) {
    debug("on request " + r);
    var el = document.getElementById('status');
    if (r == null) {
	stateStr = "connection lost";
	stateObj = {};
	el.innerText = "Status: ðŸ”´ connection lost";
	setTimeout(function () { request(null, onRequest); }, 1000);
	return;
    }

    stateStr = r;
    obj = JSON.parse(r);
    debug("old:" + stateObj.state + " new:" + obj.state);
    if (stateObj.state && stateObj.state != "idle" && obj.state == "idle") {
	// reload when going idle
	debug("reload on idle");
	window.location.reload();
	return;
    }
    stateOld = stateObj;
    stateObj = obj;
    if (stateObj.idle_time) {
	updateIdleTime();
    }
    else {
	cleanupIdleTime();
    }
    el.innerText = "Status: ðŸŸ¢ " + r;
    setTimeout(function () { request(stateStr, onRequest); }, 100);
};

var idleTimer = null;
function updateIdleTime() {
//    debug("updateIdleTime");
    if (idleTimer) {
	clearTimeout(idleTimer);
    }
    idleTimer = null;
    var el = document.getElementById('idle_time');
    var it = stateObj.idle_time;
    if (!it || it < 0) {
	cleanupIdleTime();
	return;
    }
    el.innerText = "next test after " + formatNumber(Math.floor(it / 60), 2) + ":" + formatNumber(it % 60, 2);
    idleTimer = setTimeout(function() { stateObj.idle_time -= 1; updateIdleTime(); }, 1000);
}

function cleanupIdleTime() {
    var el = document.getElementById('idle_time');
    el.innerText = "X";
    if (idleTimer) {
	clearTimeout(idleTimer);
    }
}

function initSpeedKetchup() {
    let mooSync = uPlot.sync("moo");
    const matchSyncKeys = (own, ext) => own == ext;

    const cursorOpts = {
	lock: true,
	sync: {
	    key: mooSync.key,
//	    setSeries: true,
	    match: [matchSyncKeys, matchSyncKeys],
	},
	y: false,
    };

    let axis = [
	{
            grid: {
                show: true,
                stroke: "rgba(0,0,0,0.2)",
                width: 1,
            },
	},
	{
            grid: {
                show: true,
                stroke: "rgba(0,0,0,0.2)",
                width: 1,
            },
	},
    ];
    let series = {
	points: {
	    show: false,
	    size: 5,
	    fill: "black",
	}
    };

    let d = [data[0], data[4], data[5]];
    let opts = {
	title: "Speed (Bandwidth)",
	...getSize(),
	cursor: cursorOpts,
	drawOrder: ["series", "axes"],
	series: [
	    {},
	    {
		label: "Download",
		value: (u, v) => (v == null ? d[1][d[1].length - 1] : v).toFixed(1) + "Mbps",
		fill: "rgba(255, 0, 0, 0.7)",
//		stroke: "red",
		...series,
	    },
	    {
		label: "Upload",
		value: (u, v) => (v == null ? d[2][d[2].length - 1] : v).toFixed(1) + "Mbps",
		fill: "rgba(0, 0, 255, 0.7)",
//		stroke: "blue",
		...series,
	    }
	],
	axes: axis,
    };
    let uplot = new uPlot(opts, d, document.getElementById("chart1"));

    let d2 = [data[0], data[2], data[3], data[1]];
    let opts2 = {
	title: "Ping (Latency)",
	...getSize(),
	cursor: cursorOpts,
	drawOrder: ["series", "axes"],
	series: [
	    {},
	    {
		label: "Latency While Downloading",
		value: (u, v) => (v == null ? d2[1][d2[1].length - 1] : v).toFixed(1) + "ms",
		fill: "rgba(255, 0, 0, 0.3)",
		...series,
	    },
	    {
		label: "Latency While Uploading",
		value: (u, v) => (v == null ? d2[2][d2[2].length - 1] : v).toFixed(1) + "ms",
		fill: "rgba(0, 0, 255, 0.3)",
		...series,
	    },
	    {
		label: "Latency When Idle",
		value: (u, v) => (v == null ? d2[3][d2[3].length - 1] : v).toFixed(1) + "ms",
		fill: "rgba(50, 150, 50, 1)",
		...series,
	    },
	],
	axes: axis,
    };
    let uplot2 = new uPlot(opts2, d2, document.getElementById("chart2"));

    window.addEventListener("resize", e => {
	uplot.setSize(getSize());
	uplot2.setSize(getSize());
    });

    request(null, onRequest);
}
window.onload = initSpeedKetchup;
    </script>
  </body>
</html>
